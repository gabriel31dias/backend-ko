generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL_SERVER")
}

model User {
  id                                   String           @id @default(uuid())
  name                                 String
  email                                String           @unique
  password                             String
  walletBalance                        Float            @default(0)
  walletValorReceber                   Float            @default(0)
  walletCurrency                       String           @default("BRL")
  createdAt                            DateTime         @default(now())
  updatedAt                            DateTime         @updatedAt
  corporateName                        String?
  pfDocumentFrontPath                  String?
  pfDocumentBackPath                   String?
  pfSelfieDocumentPath                 String?
  pfBankProofPath                      String?
  legalRepresentativeDocumentFrontPath String?
  legalRepresentativeDocumentBackPath  String?
  legalRepresentativeSelfiePath        String?
  pjBankProofPath                      String?
  cnpjDocumentPath                     String?
  walletGrossBalance                   Float            @default(0)
  averageTicket                        Float?
  cnpj                                 String?
  cpf                                  String?
  operationType                        String?
  phone                                String?
  salesPageLink                        String?
  addressCep                           String?
  addressStreet                        String?
  addressNumber                        String?
  addressComplement                    String?
  addressNeighborhood                  String?
  addressCity                          String?
  addressState                         String?
  documentName                         String?
  documentCpf                          String?
  accessToken                          String?
  fixedFee                             Float?
  notes                                String?
  percentageFee                        Float?
  publicKey                            String?
  secretKey                            String?
  status                               String           @default("pending")
  apiKeys                              ApiKey[]
  transactions                         Transaction[]
  walletMovements                      WalletMovement[]
  webhooks                             Webhook[]
  withdrawals                          Withdrawal[]
}

model PaymentLink {
  id                String               @id @default(uuid())
  title             String
  description       String?
  amount            Float
  currency          String
  requireEmail      Boolean
  requirePhone      Boolean
  allowCustomAmount Boolean
  maxUses           Int?
  uses              Int                  @default(0)
  status            String               @default("active")
  createdAt         DateTime             @default(now())
  expiresAt         DateTime?
  slug              String               @unique
  shareUrl          String
  brandColor        String
  accentColor       String
  backgroundImage   String?
  transactions      PaymentTransaction[]
}

model PaymentTransaction {
  id            String      @id @default(uuid())
  paymentMethod String
  status        String
  transactionId String      @unique
  pixCode       String?
  qrCodeUrl     String?
  expiresAt     DateTime?
  issuedAt      DateTime    @default(now())
  linkId        String
  link          PaymentLink @relation(fields: [linkId], references: [id])
}

model Transaction {
  id                   String    @id @default(uuid())
  amount               Float
  paymentMethod        String
  status               String
  transactionId        String    @unique
  description          String?
  customerName         String
  customerEmail        String
  customerPhone        String?
  customerDocument     String?
  customerType         String
  customerTaxId        String
  customerStreet       String
  customerNumber       String
  customerComplement   String?
  customerNeighborhood String
  customerCity         String
  customerState        String
  customerZipCode      String
  receiverUserId       String
  createdAt            DateTime  @default(now())
  approvedAt           DateTime?
  expiresAt            DateTime?
  pixCode              String?
  pixQrCode            String?
  pixExpiresAt         DateTime?
  authorizationCode    String?
  nsu                  String?
  grossAmount          Float?
  fixedFeeApplied      Float?
  percentageFeeApplied Float?
  totalFeesApplied     Float?
  netAmount            Float?
  items                Json?
  receiver             User      @relation(fields: [receiverUserId], references: [id])
}

model WalletMovement {
  id            String   @id @default(uuid())
  userId        String
  type          String
  category      String
  amount        Float
  balanceBefore Float
  balanceAfter  Float
  description   String?
  referenceType String?
  referenceId   String?
  metadata      Json?
  createdAt     DateTime @default(now())
  user          User     @relation(fields: [userId], references: [id])

  @@index([userId, createdAt])
}

model GlobalSettings {
  id          String   @id @default(uuid())
  key         String   @unique
  value       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Webhook {
  id                     String            @id @default(uuid())
  userId                 String
  url                    String
  description            String?
  eventPaymentCreated    Boolean           @default(false)
  eventPaymentCompleted  Boolean           @default(false)
  eventWithdrawCompleted Boolean           @default(false)
  eventRefund            Boolean           @default(false)
  isActive               Boolean           @default(true)
  secretKey              String?
  maxRetries             Int               @default(3)
  timeoutSeconds         Int               @default(30)
  createdAt              DateTime          @default(now())
  updatedAt              DateTime          @updatedAt
  user                   User              @relation(fields: [userId], references: [id])
  deliveries             WebhookDelivery[]

  @@index([userId])
}

model WebhookDelivery {
  id           String    @id @default(uuid())
  webhookId    String
  eventType    String
  payload      Json
  responseCode Int?
  responseBody String?
  success      Boolean   @default(false)
  attempts     Int       @default(0)
  lastAttempt  DateTime?
  nextRetry    DateTime?
  createdAt    DateTime  @default(now())
  webhook      Webhook   @relation(fields: [webhookId], references: [id])

  @@index([webhookId, createdAt])
  @@index([eventType])
}

model ApiKey {
  id          String    @id @default(uuid())
  name        String
  publicKey   String    @unique
  secretKey   String    @unique
  isActive    Boolean   @default(true)
  lastUsedAt  DateTime?
  expiresAt   DateTime?
  userId      String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  permissions String    @default("transacoes")
  user        User      @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([publicKey])
  @@index([secretKey])
}

model Withdrawal {
  id                    String   @id @default(uuid())
  userId                String
  amount                Float
  method                String
  status                String   @default("pending")
  description           String?
  bankCode              String?
  accountNumber         String?
  accountDigit          String?
  agency                String?
  agencyDigit           String?
  accountHolderName     String?
  accountHolderDocument String?
  pixKey                String?
  pixKeyType            String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  user                  User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
}

model UserLevel {
  id           String   @id @default(uuid())
  name         String
  targetAmount Float
  description  String?
  isActive     Boolean  @default(true)
  order        Int
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([order])
}

model VerificationCode {
  id        String   @id @default(uuid())
  email     String
  code      String
  expiresAt DateTime
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([email])
  @@index([email, code])
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([email])
  @@index([token])
}
